module
	kind jsfile

	import path
	var file = require('wizzi-utils').file
	var IttfDocumentStore = require('../../lib/repo/ittfDocumentStore')

	set module.exports
		{
			@ IttfDocumentStore IttfDocumentStore
			@ ProductionManager
				{
					@ productionContext
						{
							@ aclstat
								{
							@ addIttfDocument
								function
									param uri
									param content
							@ addMixedIttfModel
								function
									param uri
									param content
							@ addEvaluatedIttfModel
								function
									param uri
									param content
							@ addIttfModelBuildUpScript
								function
									param uri
									param jsScriptCoder



			@ ProductionContext
				{
					@ IttfDocumentStoreType IttfDocumentStore
					
					@ dump true

					@ addIttfDocument
						function
							param uri
							param content
					
					@ ittfModelBuildUpScripts
						{
					
					@ addIttfModelBuildUpScript
						function
							param uri
							param jsScriptCoder

							var uri = uri
							var script = jsScriptCoder.toCode()
							set this.ittfModelBuildUpScripts[uri]
								{
									@ uri uri
									@ script script
							if this.dump
								_ file.write
									_ path.join
										@ path.dirname(uri)
										@ '_debug'
										@ path.basename(uri) + '.js.dump'
									@ script

					@ raiseIttfEvaluationScriptError
						function
							param uri
							param exception
							
							var uri = uri
							var script = this.ittfModelBuildUpScripts[uri]
							if script && script.ittfEvalScript && exception && exception.lineNumber
								var lines = script.ittfEvalScript.getErrorLines(exception).join('\n')
								set exception.message = '\nError evaluating ittf in uri: ' + uri + '\n' + lines + '\n'
							else
								set exception.message = '\nError evaluating ittf in uri: ' + uri + '\n' + exception.message + '\n'
							# In case of --force proceed inside the try/catch flow
							throw exception


		

